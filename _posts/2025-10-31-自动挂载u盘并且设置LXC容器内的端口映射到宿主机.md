---
title: 自动挂载u盘并且设置LXC容器内的端口映射到宿主机
description: 
date: 2025-10-31 11:20:51 +0800
categories: []
tags: []
pin: false
math: false
mermaid: false
---

可以通过 `lsblk -f` 获取U盘的UUID  



guazai.sh：

```shell
#!/bin/bash

# 设定目标UUID
TARGET_UUID="9f7dcf4e-9a42-4443-8b57-6b5f33ca2c56"

# 检查并创建挂载点
if [ ! -d "/tf" ]; then
    mkdir /tf
    echo "已创建挂载点 /tf"
fi

# 使用blkid和grep查找具有指定UUID的设备，并分割获取设备名
DEVICE_LINE=$(blkid | grep $TARGET_UUID)
if [ -n "$DEVICE_LINE" ]; then
    DEVICE_PATH=$(echo $DEVICE_LINE | cut -d ':' -f1)
    
    # 检查设备是否已挂载，避免重复挂载
    if ! mountpoint -q /tf; then
        echo "正在挂载设备 /dev/$DEVICE_PATH 到 /tf"
        mount $DEVICE_PATH /tf
        echo "已经挂载到 /tf"
        lxc-start -n lxc_debian -f /tf/lxc_debian/config
        echo "已经启动lxc容器"
        sleep 10
        bash /root/ipt.sh
        echo "已经添加iptables规则"
        echo "使用lxc-attach -n lxc_debian进入lxc容器"
    else
        echo "/tf 已经挂载，跳过挂载操作。"
    fi
else
    echo "未找到UUID为 $TARGET_UUID 的设备。"
fi

```  


ipt：

```shell
#!/bin/sh
getip() {
    # 运行命令并提取第四个字段
    result=$(nmcli connection show --active | grep 'ethernet' | awk '{print $6}')
    # 判断结果是否为空
    if [ -z "$result" ]; then
        res=$(ifconfig "eth0" | awk '/inet / {print $2}')
        echo "$res"
    else
        res=$(ifconfig "$result" | awk '/inet / {print $2}')
        echo "$res"
    fi
}

getnet() {
    net=$(nmcli connection show --active | grep 'ethernet' | awk '{print $6}')
    if [ -z "$net" ]; then
        echo "eth0"
    else
        echo "$net"
    fi
}
ip=$(getip)
lxcip=$(lxc-info -n lxc_debian -iH | grep '^10\.0\.3')
net=$(getnet)

echo "$ip"
echo "$lxcip"
echo "$net"

# 清除所有现有的iptables规则
iptables -F
iptables -t nat -F

# 允许SSH流量直接通过
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 将所有进入宿主机的非SSH流量重定向到debian容器
iptables -t nat -A PREROUTING -i "$net" -p tcp ! --dport 22 -j DNAT --to-destination "$lxcip"

# 修改debian容器内发出的流量的源IP地址为宿主机的IP地址
iptables -t nat -A POSTROUTING -o "$net"  -j SNAT --to-source "$ip"

# 允许流量通过
iptables -A FORWARD -i "$net" -o lxcbr0 -j ACCEPT
iptables -A FORWARD -i lxcbr0 -o "$net" -m state --state ESTABLISHED,RELATED -j ACCEPT

```